---
title: "A Continuous Life-years Gained Priority Score for Ventilator Allocation"
author: "William Parker, Siva Bhavani, Susan Han, Dwight Miller, Monica Malec"
output:
  beamer_presentation:
    colortheme: beaver
    dev: pdf
    fig_height: 3
    fig_width: 6
    incremental: yes
    latex_engine: xelatex
    slide_level: 2
    theme: Berlin
    toc: yes
  html_notebook:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries, include=FALSE, cache=FALSE}
library(tidyverse)
```

\pagebreak
# Theory

## Military triage- save as many soldiers as possible

In military triage situations, a utilitarian framework is employed to save the greatest number of wounded soliders in a mass casualty event

1. Identify patients who will survive without critical care (Green)
2. Exclude patients who obviously will not survive with critical care (Blue)
3. Rank order patients who will die without critical care by $P(ICU\space Survival)$ (Red > Yellow)
4. Treat as many patients as possible in order of $P(ICU\space Survival)$


## Problems with military triage approach in the COVID-19 Pandemic 

![](three_patients.jpg)

Not everyone is a young solider...$P(ICU\space Survival)$ ignores the potential life-span of the patient!

## New York ventilator allocation policy

![](ny_tiers.png)


## 

![](ny_ranks.jpg)

Goes against "youngest first" allocation principles and does not maximize life-years saved

## Multiprinciple approach

![](white.png)
White et al, Ann Internal Medicine, 2009 **What justification for relative weight of each category?**  **Why categorical?**

\pagebreak
## Maximizing life-years gained

An alternative **utilitarian** approach is to maximize life-years gained

### Priority Score that maximizes life-years gained
$$ Priority \space Score = P(ICU\space Survival)*(100-age) $$

## Example: Maximizing life-years
![](life_year_allocation_example.jpg)

## Priority Score vs. Patient Age, by Probability of ICU Survival
```{r}
life_span_max <- 100 

tibble(
  age = seq(18, 100),
  prob_25 = 0.25,
  prob_50 = 0.5,
  prob_75 = 0.75
) %>%
  pivot_longer(cols = -age, names_to = "ICU Survival (%)", names_prefix = "prob_" ) %>%
  mutate(priority_score = value*(life_span_max - age)) %>%
  ggplot(aes(x = age, y = priority_score, color = `ICU Survival (%)`)) +
  geom_line()
```


## Range of possible priority scores by patient age

```{r}
expand.grid(seq(20,100, 10), seq(0,1,0.01)) %>%
  rename(Age = Var1, Prob = Var2) %>%
  mutate(priority_score = Prob*(life_span_max - Age)) %>%
  group_by(Age) %>%
  summarize(max_score = max(priority_score),
            min_score = min(priority_score)) %>%
  ggplot(aes(x = Age, ymin = min_score, ymax = max_score, y = max_score)) +
  geom_errorbar() +
  geom_line(aes(color = "Maximum score")) + 
  ggrepel::geom_label_repel(aes(label = max_score), color = "red") + 
  labs(y = "Priority Score", color = "")

```


\pagebreak
# Simulation using CDC data
```{r}
numextract <- function(string){ 
  as.numeric(str_extract(string, "\\-*\\d+\\.*\\d*"))
} 

comma <- function(x){
  case_when(
    abs(x) > 10 ~ format(x, digits = 0, big.mark = ",", scientific = F),
    abs(x) > 1 ~ format(x, digits = 2, big.mark = ",", scientific = F),
    TRUE ~ format(x, digits = 2, big.mark = ",", scientific = F)
  )
    
}
```

## Data sources
We took data from the CDC report [Severe Outcomes Among Patients with Coronavirus Disease 2019  — United States, February 12–March 16, 2020](https://www.cdc.gov/mmwr/volumes/69/wr/mm6912e2.htm?s_cid=mm6912e2_w)

![](cdc_age_dist.jpg)


```{r}
cdc_data <- read_csv("cdc_data.csv") %>%
  separate(`Age Group`, c("Age", "N"), sep = "\\s") %>%
  mutate(N = numextract(N),
         Age = factor(Age, levels = c("0–19", "20–44", "45–54",
                                      "55–64", "65–74", "75–84",
                                      "≥85")))
```


```{r}
total_hosp <- sum(cdc_data$N)

worst_case <- cdc_data %>%
  select(Age,
         N,
         hosp = high_hosp,
         icu = high_ICU,
         dead = high_death) %>%
  mutate(n_hosp = N*hosp/100,
         n_icu = N*icu/100,
         n_dead = N*dead/100)

total_ICU <- sum(worst_case$n_icu)

worst_case <- worst_case %>%
  mutate(pct_icu_pop = n_icu/total_ICU) %>%
  filter(Age != "0–19") %>%
  mutate(
    max_age = case_when(
      Age == "20–44" ~ 44,
      Age == "45–54" ~ 54,
      Age == "55–64" ~ 64,
      Age == "65–74" ~ 74,
      Age == "75–84" ~ 84,
      TRUE ~ 94
    ),
    min_age = case_when(
      Age == "20–44" ~ 20,
      Age == "45–54" ~ 45,
      Age == "55–64" ~ 55,
      Age == "65–74" ~ 65,
      Age == "75–84" ~ 75,
      TRUE ~ 85)
  ) %>% 
  select(Age, min_age, max_age, pct_icu_pop)
```


```{r eval = FALSE}
## COVID-19 Age Distribution of patients requiring ICU- CDC
worst_case %>%
  ggplot(aes(x = Age, y = 100*pct_icu_pop)) +
  geom_bar(stat = "Identity") + labs(y = "Percentage (%)")
```

\pagebreak




```{r eval=FALSE}

## COVID-19 ICU survival by Age in the US per the CDC
worst_case %>%
  ggplot(aes(x = Age, y = 100*survival)) +
  geom_bar(stat = "Identity") + lims(y = c(0, 100))+ labs(y = "ICU survival (%)")
```

\pagebreak
## Simulated ICU population from CDC data distribution

```{r}
SOFA <- read_csv("SOFA.csv") 

tot_SOFA <- sum(SOFA$N)

SOFA <- SOFA %>%
  mutate(sofa_num = ifelse(SOFA == ">=20", 20, as.numeric(SOFA)),
    SOFA = factor(SOFA, levels = c(seq(0,19), ">=20")),
           pct_SOFA = N/tot_SOFA)

sd_SOFA <- SOFA %>%
  uncount(N)

sd_SOFA <- sqrt(var(sd_SOFA$sofa_num))
```


```{r}
set.seed(12345)
tot_patients <- 1000
max_life_span <- 100

#degree of scarcity
num_vents <- tot_patients*0.5

simulate_ICU_pop <- function(df, N = tot_patients, sofa, mean_sofa = 8, sd_sofa = 3.5){
  
  probs <- df$pct_icu_pop
  
  age_cats <- rmultinom(1, size = N, pr = probs)
  
  sample <- tibble(age_group = character(),
                   age = numeric(),
                   alive = numeric(),
                   dead = numeric(),
                   p_surv = numeric())
  
  i <- 1
  
  
  for (n_cats in age_cats) {
    
    subgroup <- df[i,]
    
    subgroup
    
    # randomly sample ages from uniform distribution
    min_age <- subgroup$min_age
    max_age <- subgroup$max_age
    age_sample <- runif(n = n_cats, min = min_age, max = max_age)
    
    
    # sample SOFA score- assuming no correlation between age and SOFA
    
    #sofa_counts <- rmultinom(n =1, size = n_cats, pr = sofa$pct_SOFA)
    # # sofa_scores <- tibble(SOFA = sofa$SOFA,
    # #        counts = sofa_counts ) %>%
    # #   uncount(counts) %>%
    #  left_join(sofa %>% select(SOFA, death_pct)) %>%
    #   mutate(p_surv = (100-death_pct)/100)
    
    group_mean_sofa <- mean_sofa + (min_age - 65)/30

    sofa_scores <- tibble(sofa_num = round(rnorm(n = n_cats, mean = group_mean_sofa, sd = sd_sofa))) %>%
      mutate(sofa_num = case_when(
        sofa_num>= 20 ~ 20,
        sofa_num < 0 ~ 0 ,
        TRUE ~ sofa_num)) %>%
      left_join(sofa %>% select(SOFA, sofa_num, death_pct)) %>%
      mutate(p_surv = (100-death_pct)/100)
      
    
    # sample actual survival outcomes
    chance <- runif(n = n_cats)
    
    sub_sample <- tibble(age_group = subgroup$Age,
                           age = age_sample) %>%
      cbind(sofa_scores) %>%
      cbind(chance) %>%
      mutate(age = round(age),
             alive = ifelse(chance < p_surv, 1, 0))
    
    sample <- sample %>% rbind(sub_sample)
    
    i <- i + 1
  }
  
  return(sample %>% select(age_group, age, SOFA, sofa_num, p_surv, alive))
}

sim_pop <- simulate_ICU_pop(worst_case, sofa = SOFA)

total_life_years <- sum(mutate(sim_pop, life_left = max_life_span - age)$life_left)
```


```{r}
sim_pop %>%
ggplot(aes(x = age_group)) + geom_histogram(stat = "count")
```

## Simulated SOFA score distribution

```{r}
sim_pop %>%
  ggplot(aes(x = SOFA)) +
  geom_histogram(stat = "count")
```

Currently drawn from $f(SOFA |age) = N(8 + \frac{age-65}{30}, 3.5)$, need to replace with a distribution estimated from real data.


## Calibration of the SOFA score

The [Sequential Organ Failure Assesment (SOFA) score](https://en.wikipedia.org/wiki/SOFA_score)  is a validated bedside predictor of ICU mortality. The calibration of SOFA scores is drawn from [*Raith et al. JAMA, 2017*](https://jamanetwork.com/journals/jama/fullarticle/2598267)

```{r}
SOFA %>%
  ggplot(aes(x =SOFA, y = death_pct)) +
  geom_bar(stat = "Identity") + labs(y = "Mortality (%)")
```


## SOFA Score by Age
```{r}
knitr::kable(sim_pop %>%
  group_by(age_group) %>%
  summarise(mean_sofa = round(mean(sofa_num),1),
            survival = paste0(round(100*mean(p_surv)), "%")), col.names = c("Age", "Mean SOFA", "Survival with Ventilator"))
```

\pagebreak
## Simulated Hypotehtical Outcomes by Age
```{r}
# sim_pop %>%
#   group_by(age_group) %>%
#   summarise(survival = round(100*mean(alive))) %>%
#   ggplot(aes(x = age_group, y = survival)) + 
#   geom_bar(stat = "Identity") + lims(y  = c(0,100)) 


sim_pop %>%
  mutate(alive = factor(alive, labels = c("ICU Death", "Alive at ICU Discharge"))) %>%
  ggplot(aes(x = age_group, fill = alive)) +
  geom_bar() + scale_fill_manual(values = c("red4","steelblue2")) + labs(fill = "Hypothetical outcome \n(with ventilation)")
```

\pagebreak
## Lottery allocation
```{r}
lottery_allocate <- function(sim_pop, num_vents){

  lottery <- runif(n = sim_pop %>% nrow())
  
  allocate <- sim_pop %>%
    cbind(lottery) %>%
    arrange(lottery) %>%
    mutate(get_vent = factor(case_when(
      row_number() <= num_vents & alive ==1 ~  "ventilator (survival)", 
      row_number() <= num_vents ~ "ventilator (death in ICU)",
      TRUE ~ "palliative care"), levels = c("ventilator (death in ICU)", "ventilator (survival)", "palliative care"))
    )
  
  return(allocate)
}


lottery_allocation <- lottery_allocate(sim_pop, num_vents)
```

```{r}
lottery_allocation %>%
  ggplot(aes(x = age_group, fill = factor(get_vent))) + 
  geom_bar() + labs(x = "Age", fill = "")
```

## lottery allocation - ICU outcomes

```{r}
lottery_allocation %>%
  filter(get_vent != "palliative care") %>%
  ggplot(aes(x = age_group, fill = get_vent)) + 
  geom_bar() + labs(x = "Age", fill = "")
```




```{r}
lives_saved <- function(allocation){
  allocation %>% filter(get_vent == "ventilator (survival)") %>% nrow()
}


life_years_saved <- function(allocation, max_life_span = 100){
  df <- allocation %>% 
    filter(get_vent == "ventilator (survival)") %>%
    mutate(life_left = (100- age))
  
  return(sum(df$life_left))
}

pct_life_years_saved <- round(100*life_years_saved(lottery_allocation)/total_life_years)
```

A random allocation of `r num_vents` ventilators would save `r lives_saved(lottery_allocation)` out of `r tot_patients` who were in need of mechanical ventilation. A lottery saves `r  comma(life_years_saved(lottery_allocation))` (`r pct_life_years_saved`%) out of a total of possible `r comma(total_life_years)` life years.

## Lottery- age vs. SOFA
```{r}
lottery_allocation %>%
  ggplot(aes(x = age, y = SOFA, color = get_vent)) +
  geom_point() + labs(color = "")
```




\pagebreak
## Youngest first allocation

```{r}
youngest_allocate <- function(sim_pop, num_vents){

  allocate <- sim_pop %>%
    arrange(age) %>% 
    mutate(get_vent = factor(case_when(
      row_number() <= num_vents & alive ==1 ~  "ventilator (survival)", 
      row_number() <= num_vents ~ "ventilator (death in ICU)",
      TRUE ~ "palliative care"), levels = c("ventilator (death in ICU)", "ventilator (survival)", "palliative care"))
    )
  
  return(allocate)
}

young_allocation <- youngest_allocate(sim_pop, num_vents)

young_lives <- lives_saved(young_allocation)

young_lf <- life_years_saved(young_allocation)
```

```{r}
young_allocation %>%
  ggplot(aes(x = age_group, fill = factor(get_vent))) + 
  geom_bar() + labs(x = "Age", fill = "")
```

Youngest first allocation `r num_vents` ventilators would save `r young_lives` out of `r tot_patients` who were in need of mechanical ventilation. Youngest first saves `r  comma(young_lf)` (`r comma(100*young_lf/total_life_years)`%) out of a total of possible `r comma(total_life_years)` life years.

## Youngest first - ICU allocation
```{r}
young_allocation %>%
  filter(get_vent != "palliative care") %>%
  ggplot(aes(x = age_group, fill = get_vent)) + 
  geom_bar() + labs(x = "Age", fill = "")
```

## Youngest first allocation- age vs. SOFA

```{r}
young_allocation %>%
  ggplot(aes(x = age, y = SOFA, color = get_vent)) +
  geom_point() + labs(color = " ")
```


\pagebreak
## Maximizing ICU survival

```{r}
max_icu_surv <- function(sim_pop, num_vents){

  allocate <- sim_pop %>%
    arrange(-p_surv) %>% 
    mutate(get_vent = factor(case_when(
      row_number() <= num_vents & alive ==1 ~  "ventilator (survival)", 
      row_number() <= num_vents ~ "ventilator (death in ICU)",
      TRUE ~ "palliative care"), levels = c("ventilator (death in ICU)", "ventilator (survival)", "palliative care"))
    )
  return(allocate)
}


max_icu_surv_allocation <- max_icu_surv(sim_pop, num_vents)

max_icu_lf <- life_years_saved(max_icu_surv_allocation)

max_icu_lives <- lives_saved(max_icu_surv_allocation)
```

```{r}
max_icu_surv_allocation %>%
  ggplot(aes(x = age_group, fill = get_vent)) + 
  geom_bar() + labs(x = "Age", fill = "")
```

<<<<<<< HEAD
A $P(ICU \space survival)$ triage system of `r num_vents` ventilators would save `r max_icu_lives` out of `r tot_patients` patients in need. Max ICU surival saves `r comma(max_icu_lf)` out of a total of possible `r comma(total_life_years)` (`r round(100*max_icu_lf/total_life_years)`%) life-years.
=======
A $P(ICU \space survival)$ triage system of `r num_vents` ventilators would save `r max_icu_lives` out of `r tot_patients` who were in need of mechanical ventilation. Maximizing ICU survival saves `r comma(max_icu_lf)` out of a total of possible `r comma(total_life_years)` (`r round(100*max_icu_lf/total_life_years)`%) life-years.
>>>>>>> 84f5795f52500925f1b9f2efd438566dacd26751

## Maximizing ICU survival- ICU Outcomes
```{r}
max_icu_surv_allocation %>%
  filter(get_vent != "palliative care") %>%
  ggplot(aes(x = age_group, fill = get_vent)) + 
  geom_bar() + labs(x = "Age", fill = "")
```


## Max ICU survival- age vs. SOFA
```{r}
max_icu_surv_allocation %>%
  ggplot(aes(x = age, y = SOFA, color = get_vent)) +
  geom_point() + labs(color = " ")
```

\pagebreak
## Maximizing Life-years gained

```{r}
max_life_years <- function(sim_pop, num_vents){
  
  allocate <- sim_pop %>%
    mutate( priority_score = p_surv*(100-age)) %>%
    arrange(-priority_score) %>% 
    mutate(get_vent = factor(case_when(
      row_number() <= num_vents & alive ==1 ~  "ventilator (survival)", 
      row_number() <= num_vents ~ "ventilator (death in ICU)",
      TRUE ~ "palliative care"), levels = c("ventilator (death in ICU)", "ventilator (survival)", "palliative care"))
    )
  
  return(allocate)
}


max_life_year_allocation <- max_life_years(sim_pop, num_vents)

max_lf_lf <- life_years_saved(max_life_year_allocation)

max_lf_lives <- lives_saved(max_life_year_allocation)
```


```{r}
max_life_year_allocation %>%
  ggplot(aes(x = age_group, fill = get_vent)) + 
  geom_bar() + labs(x = "Age", fill = "")
```

Prioritizing life-years for `r num_vents` ventilators would save `r max_lf_lives` out of `r tot_patients` patients admitted to the ICU. Maximizing life-years gained saves `r comma(max_lf_lf)` out of a total of possible `r comma(total_life_years)` (`r round(100*max_lf_lf/total_life_years)`%) life-years.


## Max Life Years- ICU Outcomes by Age
```{r}
max_life_year_allocation %>%
  filter(get_vent != "palliative care") %>%
  ggplot(aes(x = age_group, fill = get_vent)) + 
  geom_bar() + labs(x = "Age", fill = "")
```

## Max life years- age vs. SOFA
```{r}
max_life_year_allocation%>%
  ggplot(aes(x = age, y = SOFA, color = get_vent)) +
  geom_point() + labs(color = "")
```


## Maximizing life-years vs. ICU survival

Prioritizing young sick patients over old healthy patients leads to more ICU deaths in exchange for more life-years gained.

### The Tradeoff
Prioritizing life-years gained over ICU survival saves an additional `r comma(max_lf_lf - max_icu_lf)` life-years for this `r tot_patients` patient sample, at a cost of `r  max_icu_lives - max_lf_lives` more deaths in the ICU. 


```{r,eval=FALSE}
best_case <- cdc_data %>%
  select(Age,
         N,
         hosp = low_hosp,
         icu = low_ICU,
         dead = low_death) %>%
  mutate(n_hosp = N*hosp/100,
         n_icu = N*icu/100,
         n_dead = N*dead/100)

best_case

total_ICU <- sum(best_case$n_icu)

best_case <- best_case %>%
  mutate(pct_icu_pop = n_icu/total_ICU,
                  survival = 1 - n_dead/n_icu) %>%
  filter(Age != "0–19") %>%
  mutate(
    max_age = case_when(
      Age == "20–44" ~ 44,
      Age == "45–54" ~ 54,
      Age == "55–64" ~ 64,
      Age == "65–74" ~ 74,
      Age == "75–84" ~ 84,
      TRUE ~ 94
    ),
    min_age = case_when(
      Age == "20–44" ~ 20,
      Age == "45–54" ~ 45,
      Age == "55–64" ~ 55,
      Age == "65–74" ~ 65,
      Age == "75–84" ~ 75,
      TRUE ~ 85)
  ) %>% 
  mutate(survival = ifelse(survival < 0, 0, survival)) %>%
  select(min_age, max_age, pct_icu_pop, survival)


best_case
```

